name: Build All Modes
permissions:
    contents: write
    pull-requests: write # For adding comments to PR.
on:
  workflow_dispatch:
  pull_request:
    branches:
        - 'main'
    paths-ignore:
        - 'README.md'
        - 'docs/**'
        - 'docs-export/**'

jobs:
  calculate_matrix:
    name: Calculate job matrix
    runs-on: windows-2022
    outputs:
      jobs: ${{ steps.jobs.outputs.jobs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0 # needed to get commits since last tag
          token: ${{ secrets.UEPSEUDO_PAT }}
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1.13.0

      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
      - name: Calculate the CI job matrix
        run: |
          $modes = (xmake ci --dump=modes) | ConvertTo-Json
          echo "jobs=$($modes | jq -cn --argjson modes $modes '$modes')" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        id: jobs
        shell: powershell
  build:
    name: ${{ matrix.mode }}
    needs: [ calculate_matrix ]
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix: 
        mode: ${{ fromJSON(needs.calculate_matrix.outputs.jobs) }}
        include:
          - mode: "Game__Shipping__Win64"
            artifact: true
          - mode: "Game__Debug__Win64"
            artifact: true
    steps:
      - name: Get current date as package key
        id: cache_key
        run: echo "key=$(date +'%W')" >> $GITHUB_OUTPUT
        shell: bash

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0 # needed to get commits since last tag
          token: ${{ secrets.UEPSEUDO_PAT }}
          # Force xmake to a specific folder (for cache)
      - name: Set xmake env
        run: echo "XMAKE_GLOBALDIR=${{ runner.tool_cache }}/xmake-global" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Install VS2022 BuildTools 17.9.7
        run: choco install -y visualstudio2022buildtools --version=117.9.7.0 --params "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --installChannelUri https://aka.ms/vs/17/release/180911598_-255012421/channel"
      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest
          actions-cache-folder: .xmake-cache-W${{ steps.cache_key.outputs.key }}
      - name: Update xmake repository
        run: xmake repo --update
            # Fetch xmake dephash
      - name: Retrieve dependencies hash
        id: dep_hash
        run: echo "hash=$(xmake l utils.ci.packageskey)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      # Cache xmake dependencies
      - name: Restore cached xmake dependencies
        id: restore-depcache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.XMAKE_GLOBALDIR }}\.xmake\packages
          key: MSVC-${{ matrix.mode }}-${{ steps.dep_hash.outputs.hash }}-W${{ steps.cache_key.outputs.key }}
    # Setup compilation mode and install project dependencies 
      - name: Configure xmake and install dependencies
        run: |
          cmake --version
          Import-Module 'C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\Common7\Tools\Microsoft.VisualStudio.DevShell.dll'
          Enter-VsDevShell -VsInstallPath 'C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools' -DevCmdArguments '-arch=x64 -host_arch=x64'

          xmake config -vD -m "${{matrix.mode}}" -y
        shell: powershell
      - name: Save cached xmake dependencies
        if: ${{ !steps.restore-depcache.outputs.cache-hit }}
        uses: actions/cache/save@v4
        with:
          path: ${{ env.XMAKE_GLOBALDIR }}/.xmake/packages
          key: ${{ steps.restore-depcache.outputs.cache-primary-key }}
      - name: Build
        id: build
        run: |
          xmake build -y
          $ue4ss = ((xmake ci --dump=targets) | ConvertFrom-Json)
          echo "target=$($modes.UE4SS.Target)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "symbol=$($modes.UE4SS.Symbol)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: powershell
      - name: Upload a Build Artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4.3.3
        if: ${{matrix.artifact == true}}
        with:
          name: artifact-${{matrix.mode}}
          path: |
                ${{ steps.build.outputs.target }}
                ${{ steps.build.outputs.symbol }}
          retention-days: 14
          overwrite: true
      - name: Get Date
        id: get-date
        if: ${{ matrix.artifact == true && startsWith(github.ref, 'refs/pull/')}}
        shell: powershell
        run: |
          echo "date=$([DateTime]::UtcNow.ToString('u').Replace('Z','UTC'))" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      - name: Find possible previous comment
        if: ${{ matrix.artifact == true && startsWith(github.ref, 'refs/pull/')}}
        uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e
        id: findComment
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- PR_ARTIFACT_${{matrix.mode}} -->'
      - name: Update comment
        if: ${{ matrix.artifact == true && startsWith(github.ref, 'refs/pull/')}}
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          comment-id: ${{ steps.findComment.outputs.comment-id }}
          issue-number: ${{ github.event.number }}
          body: |
            <!-- PR_ARTIFACT_${{matrix.mode}} -->
            ![badge]
            
            You can find a link to your latest successful build below.
            
            | Name     | Link                    |
            | -------- | ----------------------- |
            | Commit   | ${{ env.HEAD_SHA }}     |
            | Logs     | ${{ env.JOB_PATH }}     |
            | Download | ${{ env.ARTIFACT_URL }} |
            | Time     | ${{ env.DATE }}         |
            
            [badge]: https://img.shields.io/badge/Build_Success!-0d1117?style=for-the-badge&labelColor=3fb950&logo=data:image/svg%2bxml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZmZmZmZmIj48cGF0aCBkPSJNMjEuMDMgNS43MmEuNzUuNzUgMCAwIDEgMCAxLjA2bC0xMS41IDExLjVhLjc0Ny43NDcgMCAwIDEtMS4wNzItLjAxMmwtNS41LTUuNzVhLjc1Ljc1IDAgMSAxIDEuMDg0LTEuMDM2bDQuOTcgNS4xOTVMMTkuOTcgNS43MmEuNzUuNzUgMCAwIDEgMS4wNiAwWiI+PC9wYXRoPjwvc3ZnPg==
          edit-mode: replace
        env:
          JOB_PATH: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.job}}"
          ARTIFACT_URL: "${{ github.server_url }}/${{ github.repository }}/actions/artifacts/${{steps.upload-artifact.outputs.artifact-id }}"
          HEAD_SHA: "${{ github.head_ref }}"
          DATE: "${{ steps.get-date.outputs.date}}"
